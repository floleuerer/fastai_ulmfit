---

title: fast.ai ULMFiT with SentencePiece from pretraining to deployment


keywords: fastai
sidebar: home_sidebar



nb_path: "lib_nbs/index.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: lib_nbs/index.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><strong>Motivation:</strong>
Why even bother with a non-BERT / Transformer language model? Short answer: you can train a state of the art text classifier with ULMFiT with limited data and affordable hardware. The whole process (preparing the Wikipedia dump, pretrain the language model, fine tune the language model and training the classifier) takes about 5 hours on my workstation with a RTX 3090. The training of the model with FP16 requires less than 8 GB VRAM - so you can train the model on affordable GPUs.</p>
<p>I also saw this paper on the roadmap for fast.ai 2.3 <a href="https://arxiv.org/abs/1911.11423">Single Headed Attention RNN: Stop Thinking With Your Head</a> which could improve the performance further.</p>
<p>This Repo is based on:</p>
<ul>
<li><a href="https://github.com/fastai/fastai">https://github.com/fastai/fastai</a></li>
<li><a href="https://arxiv.org/abs/1801.06146">ULMFiT Paper</a></li>
<li>the fast.ai NLP-course repository: <a href="https://github.com/fastai/course-nlp">https://github.com/fastai/course-nlp</a></li>
</ul>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Pretrained-models">Pretrained models<a class="anchor-link" href="#Pretrained-models"> </a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<table>
<thead><tr>
<th>Language</th>
<th>(local)</th>
<th>code</th>
<th>Perplexity</th>
<th>Vocab Size</th>
<th>Tokenizer</th>
<th>Download (.tgz files)</th>
</tr>
</thead>
<tbody>
<tr>
<td>German</td>
<td>Deutsch</td>
<td>de</td>
<td>16.1</td>
<td>15k</td>
<td>SP</td>
<td><a href="https://bit.ly/ulmfit-dewiki">https://bit.ly/ulmfit-dewiki</a></td>
</tr>
<tr>
<td>Dutch</td>
<td>Nederlands</td>
<td>nl</td>
<td>20.5</td>
<td>15k</td>
<td>SP</td>
<td><a href="https://bit.ly/ulmfit-nlwiki">https://bit.ly/ulmfit-nlwiki</a></td>
</tr>
<tr>
<td>Russian</td>
<td>Русский</td>
<td>ru</td>
<td>29.8</td>
<td>15k</td>
<td>SP</td>
<td><a href="https://bit.ly/ulmfit-ruwiki">https://bit.ly/ulmfit-ruwiki</a></td>
</tr>
<tr>
<td>Portuguese</td>
<td>Português</td>
<td>pt</td>
<td>17.3</td>
<td>15k</td>
<td>SP</td>
<td><a href="https://bit.ly/ulmfit-ptwiki">https://bit.ly/ulmfit-ptwiki</a></td>
</tr>
<tr>
<td>Vietnamese</td>
<td>Tiếng Việt</td>
<td>vi</td>
<td>18.8</td>
<td>15k</td>
<td>SP</td>
<td><a href="https://bit.ly/ulmfit-viwiki">https://bit.ly/ulmfit-viwiki</a></td>
</tr>
<tr>
<td>Japanese</td>
<td>日本語</td>
<td>ja</td>
<td>42.6</td>
<td>15k</td>
<td>SP</td>
<td><a href="https://bit.ly/ulmfit-jawiki">https://bit.ly/ulmfit-jawiki</a></td>
</tr>
<tr>
<td>Italian</td>
<td>Italiano</td>
<td>it</td>
<td>23.7</td>
<td>15k</td>
<td>SP</td>
<td><a href="https://bit.ly/ulmfit-itwiki">https://bit.ly/ulmfit-itwiki</a></td>
</tr>
<tr>
<td>Spanish</td>
<td>Español</td>
<td>es</td>
<td>21.9</td>
<td>15k</td>
<td>SP</td>
<td><a href="https://bit.ly/ulmfit-eswiki">https://bit.ly/ulmfit-eswiki</a></td>
</tr>
<tr>
<td>Korean</td>
<td>한국어</td>
<td>ko</td>
<td>39.6</td>
<td>15k</td>
<td>SP</td>
<td><a href="https://bit.ly/ulmfit-kowiki">https://bit.ly/ulmfit-kowiki</a></td>
</tr>
<tr>
<td>Thai</td>
<td>ไทย</td>
<td>th</td>
<td>56.4</td>
<td>15k</td>
<td>SP</td>
<td><a href="https://bit.ly/ulmfit-thwiki">https://bit.ly/ulmfit-thwiki</a></td>
</tr>
<tr>
<td>Hebrew</td>
<td>עברית</td>
<td>he</td>
<td>46.3</td>
<td>15k</td>
<td>SP</td>
<td><a href="https://bit.ly/ulmfit-hewiki">https://bit.ly/ulmfit-hewiki</a></td>
</tr>
<tr>
<td>Arabic</td>
<td>العربية</td>
<td>ar</td>
<td>50.0</td>
<td>15k</td>
<td>SP</td>
<td><a href="https://bit.ly/ulmfit-arwiki">https://bit.ly/ulmfit-arwiki</a></td>
</tr>
<tr>
<td>Mongolian</td>
<td>Монгол</td>
<td>mn</td>
<td></td>
<td></td>
<td></td>
<td>see: <a href="https://github.com/robertritz/NLP/tree/main/02_mongolian_language_model">Github: RobertRitz</a></td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><strong>Download with wget</strong></p>

<pre><code># to preserve the filenames (.tgz!) when downloading with wget use --content-disposition
wget --content-disposition https://bit.ly/ulmfit-dewiki</code></pre>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Usage-of-pretrained-models---library-fastai_ulmfit.pretrained">Usage of pretrained models - library fastai_ulmfit.pretrained<a class="anchor-link" href="#Usage-of-pretrained-models---library-fastai_ulmfit.pretrained"> </a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>I've written a small library around this repo, to easily use the pretrained models. You don't have to bother with model, vocab and tokenizer files and paths - the following functions will take care of that.</p>
<p>Tutorial:  <a href="https://github.com/floleuerer/fastai_ulmfit/blob/main/fastai_ulmfit_pretrained_usage.ipynb">fastai_ulmfit_pretrained_usage.ipynb</a> <a href="https://colab.research.google.com/github/floleuerer/fastai_ulmfit/blob/main/fastai_ulmfit_pretrained_usage.ipynb"><img src="https://colab.research.google.com/assets/colab-badge.svg" alt="Open In Colab"></a></p>
<p><strong>Installation</strong></p>

<pre><code>pip install fastai-ulmfit</code></pre>
<p><strong>Usage</strong></p>

<pre><code># import
from fastai_ulmfit.pretrained import *

url = 'http://bit.ly/ulmfit-dewiki'

# get tokenizer - if pretrained=True, the SentencePiece Model used for language model pretraining will be used. Default: False 
tok = tokenizer_from_pretrained(url, pretrained=False)

# get language model learner for fine-tuning
learn = language_model_from_pretrained(dls, url=url, drop_mult=0.5).to_fp16()

# save fine-tuned model for classification
path = learn.save_lm('tmp/test_lm')

# get text classifier learner from fine-tuned model
learn = text_classifier_from_lm(dls, path=path, metrics=[accuracy]).to_fp16()
`</code></pre>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Model-pretraining">Model pretraining<a class="anchor-link" href="#Model-pretraining"> </a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Setup">Setup<a class="anchor-link" href="#Setup"> </a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="Python-environment">Python environment<a class="anchor-link" href="#Python-environment"> </a></h4>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">

<pre><code>fastai-2.2.7
fastcore-1.3.19
sentencepiece-0.1.95
fastinference-0.0.36</code></pre>
<p><strong>Install packages</strong>
<code>pip install -r requirements.txt</code></p>
<p>The trained language models are compatible with other fastai versions!</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="Docker">Docker<a class="anchor-link" href="#Docker"> </a></h4><p>The Wikipedia-dump preprocessing requires docker <a href="https://docs.docker.com/get-docker/">https://docs.docker.com/get-docker/</a>.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Project-structure">Project structure<a class="anchor-link" href="#Project-structure"> </a></h3>
<pre><code>.
├── we                         Docker image for the preperation of the Wikipedia-dump / wikiextractor
└── data          
    └── {language-code}wiki         
        ├── dump                    downloaded Wikipedia dump
        │   └── extract             extracted wikipedia-articles using wikiextractor
        ├── docs 
        │   ├── all                 all extracted Wikipedia articles as single txt-files
        │   ├── sampled             sampled Wikipedia articles for language model pretraining
        │   └── sampled_tok         cached tokenized sampled articles - created by fastai / sentencepiece
        └── model 
            ├── lm                  language model trained in step 2
            │   ├── fwd             forward model
            │   ├── bwd             backwards model
            │   └── spm             SentencePiece model
            │
            ├── ft                  fine tuned model trained in step 3
            │   ├── fwd             forward model
            │   ├── bwd             backwards model
            │   └── spm             SentencePiece model
            │
            └── class               classifier trained in step 4
                ├── fwd             forward learner
                └── bwd             backwards learner</code></pre>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="1.-Prepare-Wikipedia-dump-for-pretraining">1. Prepare Wikipedia-dump for pretraining<a class="anchor-link" href="#1.-Prepare-Wikipedia-dump-for-pretraining"> </a></h3><p>ULMFiT can be peretrained on relativly small datasets - 100 million tokens are sufficient to get state-of-the art classification results (compared to Transformer models as BERT, which need huge amounts of training data). The easiest way is to pretrain a language model on Wikipedia.</p>
<p>The code for the preperation steps is heavily inspired by / copied from the <strong>fast.ai NLP-course</strong>: <a href="https://github.com/fastai/course-nlp/blob/master/nlputils.py">https://github.com/fastai/course-nlp/blob/master/nlputils.py</a></p>
<p>I built a docker container and script, that automates the following steps:
1) Download Wikipedia XML-dump
2) Extract the text from the dump
3) Sample 160.000 documents with a minimum length of 1800 characters (results in 100m-120m tokens) both parameters can be changed - see the usage below</p>
<p>The whole process will take some time depending on the download speed and your hardware. For the 'dewiki' the preperation took about 45 min.</p>
<p>Run the following commands in the current directory</p>

<pre><code># build the wikiextractor docker file
docker build -t wikiextractor ./we

# run the docker container for a specific language
# docker run -v $(pwd)/data:/data -it wikiextractor -l &lt;language-code&gt; 
# for German language-code de run:
docker run -v $(pwd)/data:/data -it wikiextractor -l de
...
sucessfully prepared dewiki - /data/dewiki/docs/sampled, number of docs 160000/160000 with 110699119 words / tokens!

# To change the number of sampled documents or the minimum length see
usage: preprocess.py [-h] -l LANG [-n NUMBER_DOCS] [-m MIN_DOC_LENGTH] [--mirror MIRROR] [--cleanup]

# To cleanup indermediate files (wikiextractor and all splitted documents) run the following command. 
# The Wikipedia-XML-Dump and the sampled docs will not be deleted!
docker run -v $(pwd)/data:/data -it wikiextractor -l &lt;language-code&gt; --cleanup</code></pre>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="2.-Language-model-pretraining-on-Wikipedia-Dump">2. Language model pretraining on Wikipedia Dump<a class="anchor-link" href="#2.-Language-model-pretraining-on-Wikipedia-Dump"> </a></h3><p>Notebook: <code>2_ulmfit_lm_pretraining.ipynb</code></p>
<p>To get the best result, you can train two seperate language models - a forward and a backward model. You'll have to run the complete notebook twice and set the <code>backwards</code> parameter accordingly. The models will be saved in seperate folders (fwd / bwd). The same applies to fine-tuning and training of the classifier.</p>
<h4 id="Parameters">Parameters<a class="anchor-link" href="#Parameters"> </a></h4><p>Change the following parameters according to your needs:</p>

<pre><code>lang = 'de' # language of the Wikipedia-Dump
backwards = False # Train backwards model? Default: False for forward model
bs=128 # batch size
vocab_sz = 15000 # vocab size - 15k / 30k work fine with sentence piece
num_workers=18 # num_workers for the dataloaders
step = 'lm' # language model - don't change</code></pre>
<h4 id="Training-Logs-+-config">Training Logs + config<a class="anchor-link" href="#Training-Logs-+-config"> </a></h4><p><code>model.json</code> contains the <strong>parameters</strong> the language model was trained with and the <strong>statistics</strong> (looses and metrics) of the last epoch</p>
<div class="highlight"><pre><span></span><span class="p">{</span>
    <span class="nt">&quot;lang&quot;</span><span class="p">:</span> <span class="s2">&quot;de&quot;</span><span class="p">,</span>
    <span class="nt">&quot;step&quot;</span><span class="p">:</span> <span class="s2">&quot;lm&quot;</span><span class="p">,</span>
    <span class="nt">&quot;backwards&quot;</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
    <span class="nt">&quot;batch_size&quot;</span><span class="p">:</span> <span class="mi">128</span><span class="p">,</span>
    <span class="nt">&quot;vocab_size&quot;</span><span class="p">:</span> <span class="mi">15000</span><span class="p">,</span>
    <span class="nt">&quot;lr&quot;</span><span class="p">:</span> <span class="mf">0.01</span><span class="p">,</span>
    <span class="nt">&quot;num_epochs&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
    <span class="nt">&quot;drop_mult&quot;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">,</span>
    <span class="nt">&quot;stats&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&quot;train_loss&quot;</span><span class="p">:</span> <span class="mf">2.894167184829712</span><span class="p">,</span>
        <span class="nt">&quot;valid_loss&quot;</span><span class="p">:</span> <span class="mf">2.7784812450408936</span><span class="p">,</span>
        <span class="nt">&quot;accuracy&quot;</span><span class="p">:</span> <span class="mf">0.46221256256103516</span><span class="p">,</span>
        <span class="nt">&quot;perplexity&quot;</span><span class="p">:</span> <span class="mf">16.094558715820312</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
<p><code>history.csv</code> log of the training metrics (epochs, losses, accuracy, perplexity)</p>

<pre><code>epoch,train_loss,valid_loss,accuracy,perplexity,time
0,3.375441551208496,3.369227886199951,0.3934227228164673,29.05608367919922,23:00
...
9,2.894167184829712,2.7784812450408936,0.46221256256103516,16.094558715820312,22:44</code></pre>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="3.-Language-model-fine-tuning-on-unlabled-data">3. Language model fine-tuning on unlabled data<a class="anchor-link" href="#3.-Language-model-fine-tuning-on-unlabled-data"> </a></h3><p>Notebook: <code>3_ulmfit_lm_finetuning.ipynb</code></p>
<p>To improve the performance on the downstream-task, the language model should be fine-tuned. We are using a Twitter dataset (GermEval2018/2019), so we fine-tune the LM on unlabled tweets.</p>
<p>To use the notebook on your own dataset, create a <code>.csv</code>-file containing your (unlabled) data in the <code>text</code> column.</p>
<p>Files required from the Language Model (previous step):</p>
<ul>
<li>Model (*model.pth)</li>
<li>Vocab (*vocab.pkl)</li>
</ul>
<p>I am not reusing the SentencePiece-Model from the language model! This could lead to slightly different tokenization but fast.ai (-&gt; language_model_learner()) and the fine-tuning takes care of adding and training unknown tokens! This approch gave slightly better results than reusing the SP-Model from the language model.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="4.-Train-the-classifier">4. Train the classifier<a class="anchor-link" href="#4.-Train-the-classifier"> </a></h3><p>Notebook: <code>4_ulmfit_train_classifier.ipynb</code></p>
<p>The (fine-tuned) language model now can be used to train a classifier on a (small) labled dataset.</p>
<p>To use the notebook on your own dataset, create a <code>.csv</code>-file containing your texts in the <code>text</code> and labels in the <code>label</code> column.</p>
<p>Files required from the fine-tuned LM (previous step):</p>
<ul>
<li>Encoder (*encoder.pth)</li>
<li>Vocab (*vocab.pkl)</li>
<li>SentencePiece-Model (spm/spm.model)</li>
</ul>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="5.-Use-the-classifier-for-predictions-/-inference-on-new-data">5. Use the classifier for predictions / inference on new data<a class="anchor-link" href="#5.-Use-the-classifier-for-predictions-/-inference-on-new-data"> </a></h3><p>Notebook: <code>5_ulmfit_inference.ipynb</code></p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Evaluation">Evaluation<a class="anchor-link" href="#Evaluation"> </a></h2><h3 id="German-pretrained-model">German pretrained model<a class="anchor-link" href="#German-pretrained-model"> </a></h3><p>Results with an ensemble of forward + backward model (see the inference notebook). Neither the fine-tuning of the LM, nor the training of the classifier was optimized - so there is still room for improvement.</p>
<p>Official results: <a href="https://ids-pub.bsz-bw.de/frontdoor/deliver/index/docId/9319/file/Struss_etal._Overview_of_GermEval_task_2_2019.pdf">https://ids-pub.bsz-bw.de/frontdoor/deliver/index/docId/9319/file/Struss_etal._Overview_of_GermEval_task_2_2019.pdf</a></p>
<h4 id="Task-1-Coarse-Classification">Task 1 Coarse Classification<a class="anchor-link" href="#Task-1-Coarse-Classification"> </a></h4><p>Classes: OTHER, OFFENSE</p>
<p>Accuracy: 79,68 
F1: 75,96 (best BERT 76,95)</p>
<h4 id="Task-2-Fine-Classification">Task 2 Fine Classification<a class="anchor-link" href="#Task-2-Fine-Classification"> </a></h4><p>Classes: OTHER, PROFANITY, INSULT, ABUSE</p>
<p>Accuracy: 74,56 %
F1: 52,54 (best BERT 53.59)</p>
<h3 id="Dutch-model">Dutch model<a class="anchor-link" href="#Dutch-model"> </a></h3><p>Compared result with: <a href="https://arxiv.org/pdf/1912.09582.pdf">https://arxiv.org/pdf/1912.09582.pdf</a><br>
Dataset <a href="https://github.com/benjaminvdb/DBRD">https://github.com/benjaminvdb/DBRD</a></p>
<p>Accuracy 93,97 % (best BERT 93,0 %)</p>
<h3 id="Japanese-model">Japanese model<a class="anchor-link" href="#Japanese-model"> </a></h3><p>Copared results with:</p>
<ul>
<li><a href="https://github.com/laboroai/Laboro-BERT-Japanese">https://github.com/laboroai/Laboro-BERT-Japanese</a></li>
<li><a href="https://github.com/yoheikikuta/bert-japanese">https://github.com/yoheikikuta/bert-japanese</a>  </li>
</ul>
<p>Livedoor news corpus<br>
Accuracy 97,1% (best BERT ~98 %)</p>
<h3 id="Korean-model">Korean model<a class="anchor-link" href="#Korean-model"> </a></h3><p>Compared with: <a href="https://github.com/namdori61/BERT-Korean-Classification">https://github.com/namdori61/BERT-Korean-Classification</a>
Dataset: <a href="https://github.com/e9t/nsmc">https://github.com/e9t/nsmc</a>
Accuracy 89,6 % (best BERT 90,1 %)</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Deployment-as-REST-API">Deployment as REST-API<a class="anchor-link" href="#Deployment-as-REST-API"> </a></h2><p>see <a href="https://github.com/floleuerer/fastai-docker-deploy">https://github.com/floleuerer/fastai-docker-deploy</a></p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>.</p>

</div>
</div>
</div>
</div>
 

